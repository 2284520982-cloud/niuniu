// 漏洞渲染组件
import { CONFIG } from '../config.js';
import { escapeHtml } from '../utils.js';

const SEVERITY_COLORS = CONFIG.SEVERITY_COLORS;
const SEVERITY_ORDER = CONFIG.SEVERITY_ORDER;

export class VulnerabilityRenderer {
  constructor(container) {
    this.container = container;
    this.searchIndex = new Map();
  }

  /**
   * 构建搜索索引
   */
  buildSearchIndex(vulns) {
    this.searchIndex.clear();
    vulns.forEach((v, idx) => {
      const keywords = [
        v.sink || '',
        v.vul_type || '',
        v.file_path || '',
        v.severity || '',
        v.chain?.join(' → ') || ''
      ].filter(Boolean).join(' ').toLowerCase();
      
      this.searchIndex.set(idx, keywords);
    });
  }

  /**
   * 搜索漏洞
   */
  search(query) {
    if (!query.trim()) return [];
    
    const results = [];
    const lowerQuery = query.toLowerCase();
    
    this.searchIndex.forEach((keywords, idx) => {
      if (keywords.includes(lowerQuery)) {
        results.push(idx);
      }
    });
    
    return results;
  }

  /**
   * 渲染漏洞卡片
   */
  renderCard(vuln, index) {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.vulnIndex = index;
    
    const severity = vuln.severity || 'Low';
    const confidence = Math.round((vuln.confidence || 0) * 100);
    const vulType = vuln.vul_type || 'UNKNOWN';
    
    card.innerHTML = `
      <div class="card-head">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <span class="sev ${severity}">${severity}</span>
            <strong style="margin-left:8px;">${escapeHtml(vulType)}</strong>
            ${vuln.sink ? `<span style="color:var(--muted); margin-left:8px;">${escapeHtml(vuln.sink)}</span>` : ''}
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="confidence-badge" style="background:${this._getConfidenceColor(confidence)}">${confidence}%</span>
            ${vuln.scan_mode ? `<span class="scan-mode-tag">${vuln.scan_mode}</span>` : ''}
          </div>
        </div>
        ${vuln.file_path ? `<div style="margin-top:6px; color:var(--muted); font-size:12px;">${escapeHtml(vuln.file_path)}${vuln.line_no ? `:${vuln.line_no}` : ''}</div>` : ''}
      </div>
      <div class="card-body">
        ${this._renderChain(vuln)}
        ${this._renderMetadata(vuln)}
        ${this._renderActions(vuln)}
      </div>
    `;
    
    // 添加选择功能
    card.addEventListener('click', (e) => {
      if (!e.target.closest('.card-actions')) {
        this._toggleSelection(card, index);
      }
    });
    
    // 绑定按钮事件监听器（避免onclick中的JSON字符串转义问题）
    // AST扫描的查看源码按钮
    const viewCodeBtn = card.querySelector('.btn-view-code');
    if (viewCodeBtn) {
      viewCodeBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到卡片
        try {
          const chainData = viewCodeBtn.dataset.chain;
          if (chainData) {
            // 从base64解码JSON字符串
            const chainJson = decodeURIComponent(escape(atob(chainData)));
            if (window.viewCode) {
              window.viewCode(chainJson);
            }
          }
        } catch (e) {
          console.error('解析chain数据失败:', e);
          if (window.viewCode) {
            window.viewCode('[]');
          }
        }
      });
    }
    
    // 模板扫描的查看源码按钮
    const viewTemplateCodeBtn = card.querySelector('.btn-view-template-code');
    if (viewTemplateCodeBtn) {
      viewTemplateCodeBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到卡片
        try {
          const templateData = viewTemplateCodeBtn.dataset.template;
          if (templateData) {
            // 从base64解码JSON字符串
            const templateJson = decodeURIComponent(escape(atob(templateData)));
            if (window.viewTemplateCode) {
              window.viewTemplateCode(templateJson);
            }
          }
        } catch (e) {
          console.error('解析template数据失败:', e);
          if (window.viewTemplateCode) {
            window.viewTemplateCode('{}');
          }
        }
      });
    }
    
    const copySinkBtn = card.querySelector('.btn-copy-sink');
    if (copySinkBtn) {
      copySinkBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sink = copySinkBtn.dataset.sink;
        if (sink && window.copySink) {
          window.copySink(sink);
        }
      });
    }
    
    const copyPathBtn = card.querySelector('.btn-copy-path');
    if (copyPathBtn) {
      copyPathBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const path = copyPathBtn.dataset.path;
        if (path && window.copyPath) {
          window.copyPath(path);
        }
      });
    }
    
    return card;
  }

  _renderChain(vuln) {
    // 模板扫描结果显示文件路径和行号范围
    if (vuln.scan_mode === 'lite' || vuln.scan_mode === 'full' || (vuln.file_path && vuln.group_lines && !vuln.chain)) {
      const filePath = vuln.file_path || '';
      const lineInfo = vuln.group_lines && vuln.group_lines.length > 0 
        ? `${Math.min(...vuln.group_lines)}-${Math.max(...vuln.group_lines)}`
        : '';
      return `
        <div class="chain-row">
          <div class="chain-container">
            <span class="chain-link">${escapeHtml(filePath)}${lineInfo ? `:${lineInfo}` : ''}</span>
          </div>
        </div>
      `;
    }
    
    // AST扫描结果显示调用链
    if (!vuln.chain || vuln.chain.length === 0) return '';
    
    const chainHtml = vuln.chain.map((link, idx) => {
      return `<span class="chain-link" data-link="${idx}">${escapeHtml(link)}</span>`;
    }).join(' <span class="chain-arrow">→</span> ');
    
    return `
      <div class="chain-row">
        <div class="chain-container">${chainHtml}</div>
      </div>
    `;
  }

  _renderMetadata(vuln) {
    const items = [];
    
    if (vuln.sources && vuln.sources.length > 0) {
      items.push(`<span class="meta-item">来源: ${vuln.sources.join(', ')}</span>`);
    }
    
    if (vuln.sanitizers && vuln.sanitizers.length > 0) {
      items.push(`<span class="meta-item">净化: ${vuln.sanitizers.join(', ')}</span>`);
    }
    
    if (vuln.pattern_hits && vuln.pattern_hits.length > 0) {
      items.push(`<span class="meta-item">模式: ${vuln.pattern_hits.join(', ')}</span>`);
    }
    
    return items.length > 0 ? `<div class="metadata">${items.join(' | ')}</div>` : '';
  }

  _renderActions(vuln) {
    // 判断是模板扫描结果还是AST扫描结果
    const isTemplateScan = vuln.scan_mode === 'lite' || vuln.scan_mode === 'full' || 
                          (vuln.file_path && vuln.group_lines && !vuln.chain);
    
    let viewCodeBtn;
    if (isTemplateScan) {
      // 模板扫描：使用文件路径和行号信息
      const templateData = JSON.stringify({
        file_path: vuln.file_path || '',
        group_lines: vuln.group_lines || [],
        start: vuln.group_lines && vuln.group_lines.length > 0 ? Math.min(...vuln.group_lines) : null,
        end: vuln.group_lines && vuln.group_lines.length > 0 ? Math.max(...vuln.group_lines) : null
      });
      const templateData64 = btoa(unescape(encodeURIComponent(templateData)));
      viewCodeBtn = `<button class="btn-small btn-view-template-code" data-template="${escapeHtml(templateData64)}">查看源码</button>`;
    } else {
      // AST扫描：使用调用链
      const chainJson = JSON.stringify(vuln.chain || []);
      const chainData = btoa(unescape(encodeURIComponent(chainJson)));
      viewCodeBtn = `<button class="btn-small btn-view-code" data-chain="${escapeHtml(chainData)}">查看源码</button>`;
    }
    
    return `
      <div class="card-actions">
        ${viewCodeBtn}
        <button class="btn-small btn-copy-sink" data-sink="${escapeHtml(vuln.sink || '')}">复制Sink</button>
        <button class="btn-small btn-copy-path" data-path="${escapeHtml(vuln.file_path || '')}">复制路径</button>
      </div>
    `;
  }

  _getConfidenceColor(confidence) {
    if (confidence >= 70) return SEVERITY_COLORS.High;
    if (confidence >= 40) return SEVERITY_COLORS.Medium;
    return SEVERITY_COLORS.Low;
  }

  _toggleSelection(card, index) {
    // 选择逻辑在外部管理
    card.classList.toggle('selected');
    const event = new CustomEvent('vuln-toggle', { detail: { index, selected: card.classList.contains('selected') } });
    document.dispatchEvent(event);
  }

  /**
   * 按严重性分组渲染
   */
  renderBySeverity(vulns) {
    console.log('[VulnerabilityRenderer] renderBySeverity called:', {
      vulnsLength: vulns.length,
      container: this.container,
      containerId: this.container.id
    });
    
    const groups = {};
    SEVERITY_ORDER.forEach(sev => { groups[sev] = []; });
    
    vulns.forEach((v, idx) => {
      const sev = v.severity || 'Low';
      if (groups[sev]) {
        groups[sev].push({ vuln: v, index: idx });
      } else {
        groups.Low.push({ vuln: v, index: idx });
      }
    });

    console.log('[VulnerabilityRenderer] Groups:', Object.keys(groups).map(k => `${k}: ${groups[k].length}`));
    
    this.container.innerHTML = '';
    
    let renderedCount = 0;
    SEVERITY_ORDER.forEach(sev => {
      if (groups[sev].length === 0) return;
      
      const section = this._createCategorySection(sev, groups[sev].length);
      const body = section.querySelector('.category-body');
      
      groups[sev]
        .sort((a, b) => (b.vuln.confidence || 0) - (a.vuln.confidence || 0))
        .forEach(({ vuln, index }) => {
          try {
            body.appendChild(this.renderCard(vuln, index));
            renderedCount++;
          } catch (e) {
            console.error(`[VulnerabilityRenderer] Error rendering card ${index}:`, e);
          }
        });
      
      this.container.appendChild(section);
    });
    
    console.log(`[VulnerabilityRenderer] renderBySeverity complete: ${renderedCount} cards rendered`);
  }

  /**
   * 按类型分组渲染
   */
  renderByType(vulns) {
    console.log('[VulnerabilityRenderer] renderByType called:', {
      vulnsLength: vulns.length,
      container: this.container
    });
    
    const groups = {};
    
    vulns.forEach((v, idx) => {
      const type = v.vul_type || 'UNKNOWN';
      if (!groups[type]) groups[type] = [];
      groups[type].push({ vuln: v, index: idx });
    });

    this.container.innerHTML = '';
    
    let renderedCount = 0;
    Object.keys(groups).sort().forEach(type => {
      const section = this._createCategorySection(type, groups[type].length);
      const body = section.querySelector('.category-body');
      
      groups[type]
        .sort((a, b) => (b.vuln.confidence || 0) - (a.vuln.confidence || 0))
        .forEach(({ vuln, index }) => {
          try {
            body.appendChild(this.renderCard(vuln, index));
            renderedCount++;
          } catch (e) {
            console.error(`[VulnerabilityRenderer] Error rendering card ${index}:`, e);
          }
        });
      
      this.container.appendChild(section);
    });
    
    console.log(`[VulnerabilityRenderer] renderByType complete: ${renderedCount} cards rendered`);
  }

  /**
   * 按置信度分组渲染
   */
  renderByConfidence(vulns) {
    const groups = { high: [], medium: [], low: [] };
    
    vulns.forEach((v, idx) => {
      const conf = v.confidence || 0;
      if (conf > 0.7) groups.high.push({ vuln: v, index: idx });
      else if (conf > 0.4) groups.medium.push({ vuln: v, index: idx });
      else groups.low.push({ vuln: v, index: idx });
    });

    this.container.innerHTML = '';
    
    [
      { key: 'high', label: '高置信度 (>0.7)' },
      { key: 'medium', label: '中置信度 (0.4-0.7)' },
      { key: 'low', label: '低置信度 (<0.4)' }
    ].forEach(({ key, label }) => {
      if (groups[key].length === 0) return;
      
      const section = this._createCategorySection(label, groups[key].length);
      const body = section.querySelector('.category-body');
      
      let renderedCount = 0;
      groups[key]
        .sort((a, b) => (b.vuln.confidence || 0) - (a.vuln.confidence || 0))
        .forEach(({ vuln, index }) => {
          try {
            body.appendChild(this.renderCard(vuln, index));
            renderedCount++;
          } catch (e) {
            console.error(`[VulnerabilityRenderer] Error rendering card ${index}:`, e);
          }
        });
      
      this.container.appendChild(section);
    });
    
    console.log(`[VulnerabilityRenderer] renderByConfidence complete`);
  }

  /**
   * 渲染全部
   */
  renderAll(vulns) {
    console.log('[VulnerabilityRenderer] renderAll called:', {
      vulnsLength: vulns.length,
      container: this.container
    });
    
    this.container.innerHTML = '';
    
    let renderedCount = 0;
    vulns
      .sort((a, b) => (b.confidence || 0) - (a.confidence || 0))
      .forEach((v, idx) => {
        try {
          this.container.appendChild(this.renderCard(v, idx));
          renderedCount++;
        } catch (e) {
          console.error(`[VulnerabilityRenderer] Error rendering card ${idx}:`, e);
        }
      });
    
    console.log(`[VulnerabilityRenderer] renderAll complete: ${renderedCount} cards rendered`);
  }

  /**
   * 创建分类区域
   */
  _createCategorySection(title, count) {
    const section = document.createElement('div');
    section.className = 'category-section';
    section.innerHTML = `
      <div class="category-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
        <h3>${escapeHtml(title)} <span class="badge">${count}</span></h3>
        <span class="toggle">▼</span>
      </div>
      <div class="category-body expanded"></div>
    `;
    return section;
  }
}

